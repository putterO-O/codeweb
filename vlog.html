<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realtime Public Chat + AI Bot</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>

<style>
    body { font-family: Arial; background:#2575fc; padding:0; margin:0; display:flex; justify-content:center; }
    .chat-box { width:100%; max-width:600px; background:#fff; margin-top:40px; border-radius:15px; padding:20px;
        box-shadow:0 10px 25px rgba(0,0,0,0.2);}
    h2 { text-align:center; margin-bottom:15px; }
    .messages { height:400px; overflow-y:auto; border:1px solid #ddd; padding:10px; border-radius:10px; background:#fafafa; margin-bottom:15px; }
    .msg { padding:10px 15px; margin-bottom:10px; border-radius:10px; }
    .user-msg { background:#e9f2ff; text-align: right; } /* User's own message */
    .other-msg { background:#f0f0f0; text-align: left; } /* Other human user's message */
    .bot-msg { background:#ffeccb; text-align: left; border-left: 5px solid #ffaa00; } /* AI Bot's message */
    .msg small { color:#777; font-size: 0.75em; }
    .input-row { display:flex; gap:10px; }
    input { flex:1; padding:12px; border-radius:8px; border:1px solid #bbb; }
    button { background:#3498db; border:none; color:white; padding:12px 20px; border-radius:8px; cursor:pointer; }
</style>
</head>

<body>

<div class="chat-box">
    <h2>รีวิวร้าน(คุยเล่นก็ได้น้าาา)</h2>
    <div class="messages" id="messages"></div>

    <div class="input-row">
        <input type="text" id="msgInput" placeholder="Type a message...">
        <button onclick="sendUserMessage()">Send</button>
    </div>
</div>


<script>
/* ----------------------------------------------------------
    0) CONFIGURATION (REQUIRED!)
    *** REPLACE ALL PLACEHOLDERS BELOW WITH YOUR OWN KEYS AND DETAILS ***
---------------------------------------------------------- */
const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_APP.firebaseapp.com",
    databaseURL: "https://YOUR_APP-default-rtdb.firebaseio.com",
    projectId: "YOUR_APP",
    storageBucket: "YOUR_APP.appspot.com",
    messagingSenderId: "123",
    appId: "123"
};

const openAI_API_Key = "YOUR_OPENAI_KEY"; // *** REPLACE THIS ***

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();


/* ----------------------------------------------------------
    1) USER IDENTIFICATION
---------------------------------------------------------- */
let userName = "Guest"; 
// Prompt for a username when the page loads
while (userName === "Guest" || userName.trim() === "") {
    let input = prompt("Welcome! Please enter your desired username:");
    if (input && input.trim() !== "") {
        userName = input.trim();
    }
}


/* ----------------------------------------------------------
    2) SEND USER MESSAGE (Posts to Firebase and triggers Bot)
---------------------------------------------------------- */
function sendUserMessage() {
    const msgInput = document.getElementById("msgInput");
    const msg = msgInput.value.trim();
    if (!msg) return;

    // 2a) Send the human message to Firebase
    db.ref("chat").push().set({
        author: userName,
        text: msg,
        time: Date.now(),
        bot: false // Explicitly mark as not a bot message
    });

    // 2b) BOT replies automatically
    sendBotReply(msg); 

    // Clear the input field
    msgInput.value = "";
}

// Allow sending with the Enter key
document.getElementById("msgInput").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        sendUserMessage();
    }
});


/* ----------------------------------------------------------
    3) AI BOT LOGIC (Sends the reply to Firebase)
---------------------------------------------------------- */
async function sendBotReply(userMsg) {
    const reply = await callAI(userMsg);

    if (reply) {
        db.ref("chat").push().set({
            author: "AI Bot",
            text: reply,
            time: Date.now(),
            bot: true // Explicitly mark as a bot message
        });
    }
}

async function callAI(promptText) {
    try {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + openAI_API_Key
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                    { role: "system", content: "You are a friendly, helpful, and concise chat bot participating in a public chat. Respond briefly." },
                    { role: "user", content: promptText }
                ]
            })
        });

        if (!res.ok) {
            throw new Error(`OpenAI API request failed with status: ${res.status}`);
        }

        const data = await res.json();
        return data.choices[0].message.content;

    } catch (error) {
        console.error("Error calling AI:", error);
        return "Sorry, I'm having trouble connecting to my brain right now.";
    }
}


/* ----------------------------------------------------------
    4) REALTIME LISTENER (Displays all messages)
---------------------------------------------------------- */
const messagesDiv = document.getElementById("messages");

db.ref("chat").on("value", snapshot => {
    const data = snapshot.val();
    messagesDiv.innerHTML = ""; // Clear for full redraw

    if (!data) return;

    Object.values(data).forEach(m => {
        const el = document.createElement("div");
        el.className = "msg";
        
        // Dynamic class assignment for styling:
        if (m.bot) {
            el.classList.add("bot-msg");
        } else if (m.author === userName) {
            el.classList.add("user-msg");
        } else {
            el.classList.add("other-msg");
        }
        
        const time = new Date(m.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        el.innerHTML = `
            <strong>${m.author}</strong><br>
            ${m.text}<br>
            <small>${time}</small>
        `;

        messagesDiv.appendChild(el);
    });

    // Auto-scroll to the bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>

</body>
</html>
